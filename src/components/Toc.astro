---

type Heading = {
  depth: number;
  slug: string;
  text: string;
};

type TocH3 = Heading;

type TocH2 = Heading & {
  children: TocH3[];
};

type TocH1 = Heading & {
  children: TocH2[];
};

const { headings = [] } = Astro.props as { headings: Heading[] };

/**
 * Build hierarchy:
 * H1 → H2 → H3
 */
const tree: TocH1[] = [];

let currentH1: TocH1 | null = null;
let currentH2: TocH2 | null = null;

for (const h of headings) {
  if (h.depth === 1) {
    currentH1 = { ...h, children: [] };
    tree.push(currentH1);
    currentH2 = null;
  }

  if (h.depth === 2 && currentH1) {
    currentH2 = { ...h, children: [] };
    currentH1.children.push(currentH2);
  }

  if (h.depth === 3 && currentH2) {
    currentH2.children.push(h);
  }
}
---

{tree.length > 0 && (
  <nav aria-label="Table of contents">
    <p class="text-xs font-semibold tracking-wide text-gray-400 mb-3">
      ON THIS PAGE
    </p>

    <ul class="space-y-3 text-sm">
      {tree.map((h1) => (
        <li>
          <!-- H1 -->
          <a
            href={`#${h1.slug}`}
            class="block font-medium text-gray-800 hover:text-gray-900 no-underline"
          >
            {h1.text}
          </a>

          <!-- H2 -->
          {h1.children.length > 0 && (
            <ul class="mt-2 space-y-2 ml-4 border-l border-gray-200 pl-3">
              {h1.children.map((h2) => (
                <li>
                  <a
                    href={`#${h2.slug}`}
                    class="text-gray-600 hover:text-gray-800 no-underline"
                  >
                    {h2.text}
                  </a>

                  <!-- H3 -->
                  {h2.children?.length > 0 && (
                    <ul class="mt-1 ml-4 space-y-1">
                      {h2.children.map((h3) => (
                        <li>
                          <a
                            href={`#${h3.slug}`}
                            class="text-gray-500 hover:text-gray-700 no-underline text-xs"
                          >
                            {h3.text}
                          </a>
                        </li>
                      ))}
                    </ul>
                  )}
                </li>
              ))}
            </ul>
          )}
        </li>
      ))}
    </ul>
  </nav>
)}

